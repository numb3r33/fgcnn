---

title: module name here


keywords: fastai
sidebar: home_sidebar

summary: "API details."
description: "API details."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Todos">Todos<a class="anchor-link" href="#Todos"> </a></h2><ul>
<li>[ ] Decompose this notebook into multiple notebooks <ul>
<li>[ ] one for data preparation ( training, validation and test )</li>
<li>[ ] one for fgcnn</li>
<li>[ ] one for ipnn</li>
<li>[ ] one for experimenting with training dl models heuristics, e.g. observer batch loss graph etc.</li>
</ul>
</li>
<li>[ ] Add docs about the paper and what are the key ideas.</li>
<li>[ ] Highlight input parameter calculation in the model notebooks.</li>
<li>[ ] Add section for the dataset used for validating model results.</li>
<li>[ ] Section for further ideas and current implementation.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span>   <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span>   <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span>   <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/home/jovyan/data/&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">date_parser</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

<span class="n">df</span>      <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">14000000</span><span class="p">,</span> <span class="c1">#parse_dates=[&#39;hour&#39;], date_parser=date_parser</span>
                     <span class="p">)</span>
<span class="c1"># test set is any row on `141023`</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;141023&#39;</span><span class="p">]</span>

<span class="c1"># train set is any row </span>
<span class="n">df</span>      <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">14102300</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;train shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, test shape: </span><span class="si">{</span><span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">#df_test = pd.read_csv(DATA_DIR / &#39;test&#39; , parse_dates=[&#39;hour&#39;], date_parser=date_parser)</span>

<span class="c1"># decompose hour into weekday and hour</span>
<span class="c1"># df = df.assign(weekday=df.hour.dt.weekday)</span>
<span class="c1"># df = df.assign(click_hour=df.hour.dt.hour)</span>

<span class="c1"># df_test = df_test.assign(weekday=df_test.hour.dt.weekday)</span>
<span class="c1"># df_test = df_test.assign(click_hour=df_test.hour.dt.hour)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train shape: (9460121, 24), test shape: (3870752, 24)
CPU times: user 39.4 s, sys: 2.12 s, total: 41.5 s
Wall time: 41.5 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span>      <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">click_hour</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">click_hour</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">HourSplitter</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="s1">&#39;141022&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Create function that splits `items` between train/val with based on date.&quot;</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">indices</span>  <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">valid</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="n">hour</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">train</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">indices</span><span class="p">[</span><span class="n">train</span><span class="p">],</span><span class="n">indices</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">click</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0    0.83541
1    0.16459
Name: click, dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">cat_names</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;banner_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;site_domain&#39;</span><span class="p">,</span>
              <span class="s1">&#39;site_category&#39;</span><span class="p">,</span> <span class="s1">&#39;app_id&#39;</span><span class="p">,</span> <span class="s1">&#39;app_domain&#39;</span><span class="p">,</span> <span class="s1">&#39;app_category&#39;</span><span class="p">,</span>
              <span class="s1">&#39;device_id&#39;</span><span class="p">,</span> <span class="s1">&#39;device_ip&#39;</span><span class="p">,</span> <span class="s1">&#39;device_model&#39;</span><span class="p">,</span> <span class="s1">&#39;device_type&#39;</span><span class="p">,</span>
              <span class="s1">&#39;click_hour&#39;</span><span class="p">,</span> <span class="s1">&#39;device_conn_type&#39;</span><span class="p">,</span> <span class="s1">&#39;C14&#39;</span><span class="p">,</span> <span class="s1">&#39;C15&#39;</span><span class="p">,</span>
              <span class="s1">&#39;C16&#39;</span><span class="p">,</span> <span class="s1">&#39;C17&#39;</span><span class="p">,</span> <span class="s1">&#39;C18&#39;</span><span class="p">,</span> <span class="s1">&#39;C19&#39;</span><span class="p">,</span> <span class="s1">&#39;C20&#39;</span><span class="p">,</span> <span class="s1">&#39;C21&#39;</span>
             <span class="p">]</span>

<span class="n">cont_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">procs</span>      <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">]</span>

<span class="n">splits</span> <span class="o">=</span> <span class="n">HourSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">41</span><span class="p">)(</span><span class="n">df</span><span class="p">)</span>
<span class="c1"># splits = RandomSplitter(seed=41)(df)</span>
<span class="n">dls</span>    <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                                 <span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> 
                                 <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span> 
                                 <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span> 
                                 <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_names</span><span class="p">,</span> 
                                 <span class="n">y_names</span><span class="o">=</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> 
                                 <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> 
                                 <span class="n">bs</span><span class="o">=</span><span class="mi">2048</span>
                                <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 40.6 s, sys: 3.12 s, total: 43.8 s
Wall time: 43.5 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C1</th>
      <th>banner_pos</th>
      <th>site_id</th>
      <th>site_domain</th>
      <th>site_category</th>
      <th>app_id</th>
      <th>app_domain</th>
      <th>app_category</th>
      <th>device_id</th>
      <th>device_ip</th>
      <th>device_model</th>
      <th>device_type</th>
      <th>click_hour</th>
      <th>device_conn_type</th>
      <th>C14</th>
      <th>C15</th>
      <th>C16</th>
      <th>C17</th>
      <th>C18</th>
      <th>C19</th>
      <th>C20</th>
      <th>C21</th>
      <th>click</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8197153</th>
      <td>1005</td>
      <td>1</td>
      <td>e151e245</td>
      <td>7e091613</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>332dc66b</td>
      <td>76dc4769</td>
      <td>1</td>
      <td>15</td>
      <td>0</td>
      <td>21882</td>
      <td>320</td>
      <td>50</td>
      <td>2526</td>
      <td>0</td>
      <td>35</td>
      <td>-1</td>
      <td>221</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1815298</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>e2fcccd2</td>
      <td>5c5a694b</td>
      <td>0f2161f8</td>
      <td>a99f214a</td>
      <td>23cfd878</td>
      <td>a8964a12</td>
      <td>1</td>
      <td>08</td>
      <td>0</td>
      <td>6560</td>
      <td>320</td>
      <td>50</td>
      <td>571</td>
      <td>2</td>
      <td>39</td>
      <td>100048</td>
      <td>32</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6789492</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>e9739828</td>
      <td>df32afa9</td>
      <td>cef3e649</td>
      <td>a99f214a</td>
      <td>3e2c01db</td>
      <td>e47f989b</td>
      <td>1</td>
      <td>11</td>
      <td>0</td>
      <td>21767</td>
      <td>320</td>
      <td>50</td>
      <td>2506</td>
      <td>0</td>
      <td>35</td>
      <td>100020</td>
      <td>157</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7063646</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>66f5e02e</td>
      <td>6f7ca2ba</td>
      <td>0f2161f8</td>
      <td>c28f0035</td>
      <td>c5d4327c</td>
      <td>9e3836ff</td>
      <td>1</td>
      <td>11</td>
      <td>0</td>
      <td>21772</td>
      <td>300</td>
      <td>50</td>
      <td>2507</td>
      <td>0</td>
      <td>35</td>
      <td>-1</td>
      <td>157</td>
      <td>0</td>
    </tr>
    <tr>
      <th>809392</th>
      <td>1005</td>
      <td>0</td>
      <td>d9750ee7</td>
      <td>98572c79</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>d01c28e4</td>
      <td>4ceb2e0b</td>
      <td>1</td>
      <td>04</td>
      <td>0</td>
      <td>17914</td>
      <td>320</td>
      <td>50</td>
      <td>2043</td>
      <td>2</td>
      <td>39</td>
      <td>100084</td>
      <td>32</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8312094</th>
      <td>1005</td>
      <td>0</td>
      <td>1fbe01fe</td>
      <td>f3845767</td>
      <td>28905ebd</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>1812cdb7</td>
      <td>23885c9e</td>
      <td>1</td>
      <td>16</td>
      <td>0</td>
      <td>15704</td>
      <td>320</td>
      <td>50</td>
      <td>1722</td>
      <td>0</td>
      <td>35</td>
      <td>-1</td>
      <td>79</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3817921</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>8bbb7062</td>
      <td>ef1fc174</td>
      <td>0f2161f8</td>
      <td>5c01cfbc</td>
      <td>2b0f4c31</td>
      <td>fce66524</td>
      <td>1</td>
      <td>20</td>
      <td>0</td>
      <td>21189</td>
      <td>320</td>
      <td>50</td>
      <td>2424</td>
      <td>1</td>
      <td>161</td>
      <td>-1</td>
      <td>71</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4375335</th>
      <td>1005</td>
      <td>1</td>
      <td>5b4d2eda</td>
      <td>16a36ef3</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>0cdc2afe</td>
      <td>76dc4769</td>
      <td>1</td>
      <td>02</td>
      <td>0</td>
      <td>19950</td>
      <td>320</td>
      <td>50</td>
      <td>1800</td>
      <td>3</td>
      <td>167</td>
      <td>100075</td>
      <td>23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3324163</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>e2a1ca37</td>
      <td>2347f47a</td>
      <td>8ded1f7a</td>
      <td>ee459291</td>
      <td>ad01d971</td>
      <td>47a322d1</td>
      <td>1</td>
      <td>17</td>
      <td>0</td>
      <td>17016</td>
      <td>320</td>
      <td>50</td>
      <td>1873</td>
      <td>3</td>
      <td>39</td>
      <td>-1</td>
      <td>23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8414628</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>7358e05e</td>
      <td>b9528b13</td>
      <td>cef3e649</td>
      <td>7961236b</td>
      <td>a1ce9c97</td>
      <td>684581ce</td>
      <td>1</td>
      <td>17</td>
      <td>0</td>
      <td>1037</td>
      <td>320</td>
      <td>50</td>
      <td>178</td>
      <td>3</td>
      <td>1327</td>
      <td>-1</td>
      <td>15</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Embeddings">Embeddings<a class="anchor-link" href="#Embeddings"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_fixed_emb_sz</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="s2">&quot;Pick a fixed embedding size for `n` based on `k`.&quot;</span>
    <span class="n">n_cat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
    <span class="n">sz</span>    <span class="o">=</span> <span class="n">k</span>  <span class="c1"># rule of thumb</span>
    <span class="k">return</span> <span class="n">n_cat</span><span class="p">,</span><span class="n">sz</span>

<span class="k">def</span> <span class="nf">get_emb_sz</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="s2">&quot;Get default embedding size from `TabularPreprocessor` `proc` or the ones in `sz_dict`&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_fixed_emb_sz</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">to</span><span class="o">.</span><span class="n">cat_names</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Avazu-Model-(-FGCNN-v2-)">Avazu Model ( FGCNN v2 )<a class="anchor-link" href="#Avazu-Model-(-FGCNN-v2-)"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConvPoolRecombine</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input : ( N, C_in, H, W ), where w represents `k` ( emebdding size )</span>
<span class="sd">    output: ( N, new_i, H / 2, W), where `2` represents max pool kernel size which is fixed as `2` for now.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_in</span><span class="p">,</span> <span class="n">ch_out</span><span class="p">,</span> <span class="n">recomb_ch_out</span><span class="p">,</span> <span class="n">out_wh</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">ch_in</span><span class="p">,</span>
                              <span class="n">out_channels</span><span class="o">=</span><span class="n">ch_out</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                              <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                             <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>   <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>   <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">recomb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">out_wh</span><span class="o">*</span><span class="n">ch_out</span><span class="p">,</span> <span class="n">out_wh</span><span class="o">*</span><span class="n">recomb_ch_out</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">embed_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># output shape: (N, C_out, H, W)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
        <span class="c1"># output shape: (N, C_out, H / hp, W), where hp = `2`</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
        <span class="c1"># output shape: (N, H / hp, W, C_out)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        
        <span class="c1"># flattening</span>
        <span class="c1"># shape: (N, H/2*W*C_out)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># recombining</span>
        <span class="c1"># shape: (N, H/2, W, C_new)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recomb</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recomb_ch_out</span><span class="p">)</span>
        
        <span class="c1"># shape: (N, c_new*H/hp, W)</span>
        <span class="n">out_r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">out_r</span>
    
<span class="k">class</span> <span class="nc">FGCNN_v2</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb_szs</span><span class="p">,</span> <span class="n">conv_kernels</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">dense_layers</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        emb_szs     : list of tuples representing embedding size e.g. [(4, k), (6, k)]</span>
<span class="sd">        conv_kernels: list of convolutional kernels</span>
<span class="sd">        kernels     : kernels to be used</span>
<span class="sd">        h           : convolutional filter size</span>
<span class="sd">        hp          : pooling kernel size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span>        <span class="o">=</span> <span class="n">emb_szs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">embeds</span>   <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">Embedding</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span> <span class="k">for</span> <span class="n">ni</span><span class="p">,</span><span class="n">nf</span> <span class="ow">in</span> <span class="n">emb_szs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_emb</span>    <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeds</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ConvPoolRecombine</span><span class="p">(</span><span class="n">ch_in</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">conv_kernels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                                                            <span class="n">ch_out</span><span class="o">=</span><span class="n">conv_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                            <span class="n">recomb_ch_out</span><span class="o">=</span><span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                            <span class="n">out_wh</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                                                            <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> 
                                                            <span class="n">hp</span><span class="o">=</span><span class="n">hp</span>
                                                           <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conv_kernels</span><span class="p">))</span>
                                         <span class="p">])</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">/</span> <span class="p">(</span><span class="n">hp</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conv_kernels</span><span class="p">))])</span> <span class="o">*</span> <span class="n">kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">N</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># MLP classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">LinBnDrop</span><span class="p">(</span><span class="n">n_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_in</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>  <span class="k">else</span> <span class="n">dense_layers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                                            <span class="n">n_out</span><span class="o">=</span><span class="n">dense_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                            <span class="n">act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act</span>
                                            <span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_layers</span><span class="p">))</span>
                                 <span class="p">])</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">final_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">dense_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span>      <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        
        <span class="n">store_attr</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_emb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeds</span><span class="p">)]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
        <span class="n">embed</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        
        <span class="n">input_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        
        <span class="n">p</span>     <span class="o">=</span> <span class="n">input_x</span>
        <span class="n">out_r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span><span class="p">)):</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">p</span><span class="p">)</span>
            <span class="n">out_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        
        <span class="c1"># shape: (bs, C_new * ( H / 2 ^ i), embed_size)</span>
        <span class="n">new_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out_r</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># combine features</span>
        <span class="n">aug_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">embed</span><span class="p">,</span> <span class="n">new_features</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># inner product factorization machine using augmented embedding matrix</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aug_emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">aug_emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">aug_emb</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:],</span>
                                             <span class="n">aug_emb</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
                                   <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">fm</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># flatten</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">fm</span><span class="p">,</span> <span class="n">embed</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">out</span><span class="p">)</span>
            
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_linear</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Avazu-Model-(-FGCNN-v1-)">Avazu Model ( FGCNN v1 )<a class="anchor-link" href="#Avazu-Model-(-FGCNN-v1-)"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_make_conv</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">ni</span><span class="p">,</span> 
                                   <span class="n">out_channels</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> 
                                   <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> 
                                   <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                  <span class="p">),</span>
                         <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">(),</span>
                         <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_recombination</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">mr</span><span class="p">):</span>
    <span class="n">fan_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">nf</span> <span class="o">//</span> <span class="n">hp</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">nf</span> <span class="o">//</span> <span class="n">hp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">fan_in</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">mc</span><span class="p">,</span>
                     <span class="n">out_features</span><span class="o">=</span><span class="n">fan_in</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">mr</span>
                    <span class="p">)</span>


<span class="k">class</span> <span class="nc">IPNN</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dense_layers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span>     <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span>         <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_bn_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">LinBnDrop</span><span class="p">(</span><span class="n">n_in</span><span class="o">=</span><span class="n">dense_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                    <span class="n">n_out</span><span class="o">=</span><span class="n">dense_layers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act</span>
                                                   <span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                         <span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">final_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">dense_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span>      <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aug_emb</span><span class="p">):</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aug_emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">aug_emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">aug_emb</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:],</span>
                                             <span class="n">aug_emb</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
                                   <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">fm</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rfm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">fm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aug_emb</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">dense_out</span> <span class="o">=</span> <span class="n">rfm</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_bn_drop</span><span class="p">)):</span>
            <span class="n">dense_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_bn_drop</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">dense_out</span><span class="p">)</span>
        
        <span class="n">final_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_linear</span><span class="p">(</span><span class="n">dense_out</span><span class="p">)</span>
        <span class="n">out</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">final_res</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span>
        
<span class="k">class</span> <span class="nc">FGCNN</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb_szs</span><span class="p">,</span> <span class="n">conv_kernels</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        emb_szs     : list of tuples representing embedding size e.g. [(4, k), (6, k)]</span>
<span class="sd">        conv_kernels: list of convolutional kernels</span>
<span class="sd">        kernels     : kernels to be used</span>
<span class="sd">        h           : convolutional filter size</span>
<span class="sd">        hp          : pooling kernel size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span>      <span class="o">=</span> <span class="n">emb_szs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">Embedding</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span> <span class="k">for</span> <span class="n">ni</span><span class="p">,</span><span class="n">nf</span> <span class="ow">in</span> <span class="n">emb_szs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_emb</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeds</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">_make_conv</span><span class="p">(</span><span class="n">ni</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="n">conv_kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="o">=</span><span class="n">hp</span><span class="p">)]</span>  <span class="o">+</span>\
                                         <span class="p">[</span><span class="n">_make_conv</span><span class="p">(</span><span class="n">conv_kernels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">conv_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="o">=</span><span class="n">hp</span><span class="p">)</span> \
                                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv_kernels</span><span class="p">))]</span>
                                        <span class="p">)</span>
        
        <span class="n">nf</span>          <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conv_kernels</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_make_recombination</span><span class="p">(</span><span class="n">nf</span> <span class="o">//</span> <span class="p">(</span><span class="n">hp</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">conv_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mr</span><span class="o">=</span><span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
            
        <span class="n">store_attr</span><span class="p">()</span>
        
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_emb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeds</span><span class="p">)]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># embed is embedding matrix that would be used in deep</span>
        <span class="c1"># classifier.</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        
        <span class="c1"># x is embedding matrix used for feature generation</span>
        <span class="n">x</span>   <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># adding a single channel for convolution</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">recombined</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">out</span><span class="p">)</span>
            
            <span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">flat</span><span class="p">)</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
            
            <span class="n">recombined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>
            
        <span class="n">recombined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">recombined</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">recombined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">recombined</span><span class="p">,</span> <span class="n">embed</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recombined</span>        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AvazuModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">emb_szs</span><span class="p">,</span> <span class="n">conv_kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">h</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">hp</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dense_layers</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># store all attributes</span>
        <span class="n">store_attr</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fgcnn</span>   <span class="o">=</span> <span class="n">FGCNN</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">,</span> <span class="n">conv_kernels</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fgcnn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_feats</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">,</span> <span class="n">kernels</span><span class="p">)</span>
        
        <span class="n">tot_f</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fgcnn</span>
        <span class="n">tot_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_f</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">tot_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">tot_f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="n">dense_layers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tot_f</span><span class="p">)]</span> <span class="o">+</span> <span class="n">dense_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipnn</span>    <span class="o">=</span> <span class="n">IPNN</span><span class="p">(</span><span class="n">dense_layers</span><span class="p">)</span>
        
        
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fgcnn</span><span class="p">(</span><span class="n">x_cat</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipnn</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">get_num_feats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb_szs</span><span class="p">,</span> <span class="n">kernels</span><span class="p">):</span>
        <span class="n">n_feats</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">)</span>
        <span class="n">num_maps</span> <span class="o">=</span> <span class="n">n_feats</span> 
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)):</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_feats</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            
        <span class="k">return</span> <span class="n">n</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cats</span><span class="p">,</span> <span class="n">conts</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_szs</span> <span class="o">=</span> <span class="n">get_emb_sz</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">FGCNN_v2</span><span class="p">(</span><span class="n">emb_szs</span><span class="o">=</span><span class="n">emb_szs</span><span class="p">,</span> 
             <span class="n">conv_kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> 
             <span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
             <span class="n">dense_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
             <span class="n">h</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
             <span class="n">hp</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>torch.Size([2048, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Avazu-Model-using-FGCNN-v1">Avazu Model using FGCNN v1<a class="anchor-link" href="#Avazu-Model-using-FGCNN-v1"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_szs</span> <span class="o">=</span> <span class="n">get_emb_sz</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">m</span>       <span class="o">=</span> <span class="n">AvazuModel</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> 
                     <span class="n">emb_szs</span><span class="o">=</span><span class="n">emb_szs</span><span class="p">,</span> 
                     <span class="n">conv_kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> 
                     <span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                     <span class="n">dense_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
                    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="FGCNN-v2">FGCNN v2<a class="anchor-link" href="#FGCNN-v2"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_szs</span> <span class="o">=</span> <span class="n">get_emb_sz</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">FGCNN_v2</span><span class="p">(</span><span class="n">emb_szs</span><span class="o">=</span><span class="n">emb_szs</span><span class="p">,</span> 
             <span class="n">conv_kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> 
             <span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
             <span class="n">dense_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span>
             <span class="n">h</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
             <span class="n">hp</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">TabularLearner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">BCELossFlat</span><span class="p">(),</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">ranger</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/jovyan/my-conda-envs/dev/lib/python3.8/site-packages/fastai/callback/schedule.py:269: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &#34;ro&#34; (-&gt; color=&#39;r&#39;). The keyword argument will take precedence.
  ax.plot(val, idx, &#39;ro&#39;, label=nm, c=color)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(valley=0.00019054606673307717)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYgAAAEKCAYAAAAIO8L1AAAAOXRFWHRTb2Z0d2FyZQBNYXRwbG90bGliIHZlcnNpb24zLjQuMywgaHR0cHM6Ly9tYXRwbG90bGliLm9yZy/MnkTPAAAACXBIWXMAAAsTAAALEwEAmpwYAAAoH0lEQVR4nO3de3Rc5Xnv8e8zN90ty7Zs8AVswJR7gAjahpJFG24tCbDK4RbWCZyQsNKE0CYpp7DaQzhOcpquniZpUppAEpI0lzo+TkOc4pZLCiENIbEMhAYTsGwglgFLlmRZmpHm+pw/ZksMYixLtrZmRvp91pql2e/ee/bzSpp55t3vu/dr7o6IiMhEkUoHICIi1UkJQkREylKCEBGRspQgRESkLCUIEREpSwlCRETKioX54mZ2MfD3QBT4irt/esL6zwK/Hyw2AkvdfWGw7nrgr4J1n3T3b0x2rCVLlvjq1atnLngRkXlg69ate929vdw6C+s6CDOLAi8AFwDdwBbgWnffdoDtPwyc4e7vNbNFQCfQATiwFXiruw8c6HgdHR3e2dk5w7UQEZnbzGyru3eUWxfmKaazgS533+nuGWA9cNkk218L/HPw/CLgIXfvD5LCQ8DFIcYqIiIThJkgVgC7Spa7g7I3MbOjgTXAf0xnXzO7ycw6zayzt7d3RoIWEZGiaumkvgbY6O756ezk7ve4e4e7d7S3lz2FJiIihyjMTurdwKqS5ZVBWTnXAB+asO95E/Z9dLoBZLNZuru7GR0dne6uc0Z9fT0rV64kHo9XOhQRqTFhJogtwFozW0PxA/8a4N0TNzKzE4A24GclxQ8A/8fM2oLlC4HbpxtAd3c3LS0trF69GjOb7u41z93p6+uju7ubNWvWVDocEakxoZ1icvcccDPFD/vngA3u/qyZrTOzS0s2vQZY7yXDqdy9H/gExSSzBVgXlE3L6OgoixcvnpfJAcDMWLx48bxuQYnIoQv1Ogh33wxsnlB2x4TlOw+w773AvYcbw3xNDmPme/1F5rrOl/px4KzVi2b8taulk1oCzc3NALz00kuccsopFY5GRKrd3/9oO5+6/7lQXlsJotQzG+Czp8CdC4s/n9lQ6YhERCbVn8ywuCkRymsrQYx5ZgP88BYY3AV48ecPbznsJHHbbbdx1113jS/feeedfPKTn+Qd73gHZ555Jqeeeio/+MEPJn2NfD7PrbfeyllnncVpp53G3XffDcB73vMe7rvvvvHtrrvuuoO+lojMLf3JDG1KECH70TrIjryxLDtSLD8MV199NRs2vJ5kNmzYwPXXX8/3v/99nnzySR555BE+9rGPMdktT7761a/S2trKli1b2LJlC1/+8pd58cUXufHGG/n6178OwODgII8//jiXXHLJYcUrIrXD3elPZlgUUoIItZO6pgx2T698is444wx6enp45ZVX6O3tpa2tjSOOOIKPfOQjPPbYY0QiEXbv3s2ePXs44ogjyr7Ggw8+yDPPPMPGjRuLIQ0Osn37di688EI++MEP0tvby/e+9z2uuOIKYjH9SUXmi5FsnnSuoAQRutaVwemlMuWH6corr2Tjxo289tprXH311Xz729+mt7eXrVu3Eo/HWb169aRDUd2dL3zhC1x00UVvWvee97yHb33rW6xfv56vfe1rhx2riNSO/mQGgEWNOsUUrnfcAfGGN5bFG4rlh+nqq69m/fr1bNy4kSuvvJLBwUGWLl1KPB7nkUce4eWXX550/4suuogvfvGLZLNZAF544QWSySQAN9xwA5/73OcAOOmkkw47VhGpHWMJIqw+CLUgxpx2VfHnj9YVTyu1riwmh7Hyw3DyySczNDTEihUrOPLII7nuuut417vexamnnkpHRwcnnHDCpPu/733v46WXXuLMM8/E3Wlvbx/vnF62bBknnngil19++WHHKSK1ZbwF0RTOrXRCmw9itpWbD+K5557jxBNPrFBEsyOVSnHqqafy5JNP0traWnab+fB7EJmPvv9UNx/57i955M/PY82SpkN6jUrNByEhe/jhhznxxBP58Ic/fMDkICJzV99wuH0QOsVUw84///yD9l+IyNw1kMoQjRgt9eF8lKsFISJSo/qTWdoa40Qi4dxzbc4niLnSx3Ko5nv9ReaygRAvkoM5niDq6+vp6+ubtx+SY/NB1NfXVzoUEQlBfzJDW0j9DzDH+yBWrlxJd3c383m+6rEZ5URk7ulPZVi7tDm015/TCSIej2smNRGZswZCvFEfzPFTTCIic1Wh4AykwrvVNyhBiIjUpMGRLAUn1D4IJQgRkRrUnxq7zYYShIiIlBgI+UZ9EHKCMLOLzex5M+sys9sOsM1VZrbNzJ41s++UlOfN7OngsSnMOEVEas3YjfrC7IMIbRSTmUWBu4ALgG5g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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2e-4</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">EarlyStoppingCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='0' class='' max='1' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.00% [0/1 00:00<00:00]
    </div>
    
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table><p>

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='2127' class='' max='3695' style='width:300px; height:20px; vertical-align: middle;'></progress>
      57.56% [2127/3695 4:08:48<3:03:25 0.3431]
    </div>
    
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s1">&#39;models&#39;</span> <span class="o">/</span> <span class="s1">&#39;fgcnn_v2_single_epoch_es_but_last_day.pkl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl</span>    <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">dl</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst</span> <span class="o">=</span> <span class="n">BCELossFlat</span><span class="p">()</span>
<span class="n">tst</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorBase(0.4240)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sub</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s1">&#39;sampleSubmission&#39;</span><span class="p">)</span>
<span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;click&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">sub</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s1">&#39;submissions&#39;</span> <span class="o">/</span> <span class="s1">&#39;fgcnn_v2_single_epoch_es_but_last_day.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

