---

title: Data Preparation


keywords: fastai
sidebar: home_sidebar

summary: "Module to prepare data for experiments"
description: "Module to prepare data for experiments"
nb_path: "01_data.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Train-Test-Split">Train Test Split<a class="anchor-link" href="#Train-Test-Split"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_dataset" class="doc_header"><code>read_dataset</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_dataset</code>(<strong><code>nrows</code></strong>:<code>int</code>=<em><code>14000000</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_time_feat" class="doc_header"><code>add_time_feat</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_time_feat</code>(<strong><code>df</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_train_test" class="doc_header"><code>split_train_test</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L22" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_train_test</code>(<strong><code>df</code></strong>, <strong><code>crit</code></strong>)</p>
</blockquote>
<p>Split dataset ( df ) based on a criterion/filter</p>
<p>Arguments:
    df  : Dataset
    crit: criterion/filter</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_dataset" class="doc_header"><code>make_dataset</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_dataset</code>(<strong><code>df</code></strong>, <strong><code>crit</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span>     <span class="o">=</span> <span class="n">read_dataset</span><span class="p">()</span>
<span class="n">df</span>     <span class="o">=</span> <span class="n">add_time_feat</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">crit</span>   <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;141023&#39;</span>
<span class="n">tr</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">make_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">crit</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10129248</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te</span><span class="p">)</span> <span class="o">==</span>  <span class="mi">3870752</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tr shape: (10129248, 24), te shape: (3870752, 24)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Splitting-Strategy">Splitting Strategy<a class="anchor-link" href="#Splitting-Strategy"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DateSplitter" class="doc_header"><code>DateSplitter</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L44" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DateSplitter</code>(<strong><code>dt</code></strong>=<em><code>'141022'</code></em>, <strong><code>seed</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Create function that splits <code>items</code> between train/val with based on date.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tr_splits</span><span class="p">,</span> <span class="n">va_splits</span> <span class="o">=</span> <span class="n">DateSplitter</span><span class="p">()(</span><span class="n">tr</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4792122</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">va_splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5337126</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(4792122,) (5337126,)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="DataLoaders">DataLoaders<a class="anchor-link" href="#DataLoaders"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_dl" class="doc_header"><code>create_dl</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_dl</code>(<strong><code>df</code></strong>, <strong><code>bs</code></strong>, <strong><code>target</code></strong>, <strong><code>cat_names</code></strong>, <strong><code>cont_names</code></strong>, <strong><code>procs</code></strong>, <strong><code>splitter</code></strong>)</p>
</blockquote>
<p>Create function that prepares <code>dataloader</code> using several arguments.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat_names</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;banner_pos&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;site_id&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;site_domain&#39;</span><span class="p">,</span>
              <span class="s1">&#39;site_category&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;app_id&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;app_domain&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;app_category&#39;</span><span class="p">,</span>
              <span class="s1">&#39;device_id&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;device_ip&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;device_model&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;device_type&#39;</span><span class="p">,</span>
              <span class="s1">&#39;device_conn_type&#39;</span><span class="p">,</span>
              <span class="s1">&#39;click_hour&#39;</span>
              <span class="s1">&#39;C14&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C15&#39;</span><span class="p">,</span>
              <span class="s1">&#39;C16&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C17&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C18&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C19&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C20&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;C21&#39;</span>
             <span class="p">]</span>

<span class="n">cont_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">procs</span>      <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">]</span>
<span class="n">target</span>     <span class="o">=</span> <span class="s1">&#39;click&#39;</span>
<span class="n">bs</span>         <span class="o">=</span> <span class="mi">2048</span>
<span class="n">splitter</span>   <span class="o">=</span> <span class="n">DateSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">41</span><span class="p">)</span>

<span class="n">dls</span>        <span class="o">=</span> <span class="n">create_dl</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cat_names</span><span class="p">,</span> <span class="n">cont_names</span><span class="p">,</span> <span class="n">procs</span><span class="p">,</span> <span class="n">splitter</span><span class="p">)</span>

<span class="n">dls</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C1</th>
      <th>banner_pos</th>
      <th>site_id</th>
      <th>site_domain</th>
      <th>site_category</th>
      <th>app_id</th>
      <th>app_domain</th>
      <th>app_category</th>
      <th>device_id</th>
      <th>device_ip</th>
      <th>device_model</th>
      <th>device_type</th>
      <th>device_conn_type</th>
      <th>C14</th>
      <th>C15</th>
      <th>C16</th>
      <th>C17</th>
      <th>C18</th>
      <th>C19</th>
      <th>C20</th>
      <th>C21</th>
      <th>click</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3280536</th>
      <td>1010</td>
      <td>1</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>826c565e</td>
      <td>7801e8d9</td>
      <td>0f2161f8</td>
      <td>8a7fb045</td>
      <td>be23dbfa</td>
      <td>f07e20f8</td>
      <td>4</td>
      <td>0</td>
      <td>21790</td>
      <td>320</td>
      <td>50</td>
      <td>2513</td>
      <td>3</td>
      <td>35</td>
      <td>-1</td>
      <td>68</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10013407</th>
      <td>1002</td>
      <td>0</td>
      <td>1ee69d19</td>
      <td>ce81106c</td>
      <td>50e219e0</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>60b5cd1b</td>
      <td>e2c233db</td>
      <td>507de649</td>
      <td>0</td>
      <td>0</td>
      <td>15908</td>
      <td>320</td>
      <td>50</td>
      <td>1752</td>
      <td>3</td>
      <td>297</td>
      <td>100081</td>
      <td>82</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7790564</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>36f58dec</td>
      <td>2347f47a</td>
      <td>f95efa07</td>
      <td>a99f214a</td>
      <td>8e787681</td>
      <td>d780319b</td>
      <td>1</td>
      <td>0</td>
      <td>21767</td>
      <td>320</td>
      <td>50</td>
      <td>2506</td>
      <td>0</td>
      <td>35</td>
      <td>-1</td>
      <td>157</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6718210</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>e9739828</td>
      <td>df32afa9</td>
      <td>cef3e649</td>
      <td>a99f214a</td>
      <td>d6c0acb1</td>
      <td>e55b4de4</td>
      <td>1</td>
      <td>0</td>
      <td>21768</td>
      <td>320</td>
      <td>50</td>
      <td>2506</td>
      <td>0</td>
      <td>35</td>
      <td>100020</td>
      <td>157</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4512824</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>66f5e02e</td>
      <td>6f7ca2ba</td>
      <td>0f2161f8</td>
      <td>a99f214a</td>
      <td>fc895806</td>
      <td>2891f384</td>
      <td>1</td>
      <td>0</td>
      <td>21678</td>
      <td>320</td>
      <td>50</td>
      <td>2495</td>
      <td>2</td>
      <td>167</td>
      <td>-1</td>
      <td>23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6886687</th>
      <td>1002</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>a37bf1e4</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>dce843f8</td>
      <td>97d296f6</td>
      <td>3bcda2fe</td>
      <td>0</td>
      <td>0</td>
      <td>14265</td>
      <td>320</td>
      <td>50</td>
      <td>1526</td>
      <td>2</td>
      <td>169</td>
      <td>100111</td>
      <td>35</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6909109</th>
      <td>1005</td>
      <td>0</td>
      <td>cd58172f</td>
      <td>b9c4ab81</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>cfcbdff7</td>
      <td>158e4944</td>
      <td>1</td>
      <td>0</td>
      <td>17877</td>
      <td>320</td>
      <td>50</td>
      <td>2036</td>
      <td>3</td>
      <td>47</td>
      <td>-1</td>
      <td>156</td>
      <td>0</td>
    </tr>
    <tr>
      <th>648145</th>
      <td>1005</td>
      <td>0</td>
      <td>23d99ea0</td>
      <td>6bdbd889</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>339649fc</td>
      <td>6e1e2240</td>
      <td>1</td>
      <td>0</td>
      <td>16208</td>
      <td>320</td>
      <td>50</td>
      <td>1800</td>
      <td>3</td>
      <td>167</td>
      <td>100074</td>
      <td>23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5713179</th>
      <td>1005</td>
      <td>0</td>
      <td>4e7614cf</td>
      <td>c1aa3c04</td>
      <td>f028772b</td>
      <td>ecad2386</td>
      <td>7801e8d9</td>
      <td>07d7df22</td>
      <td>a99f214a</td>
      <td>e70f5b2e</td>
      <td>8ef046ab</td>
      <td>1</td>
      <td>0</td>
      <td>21764</td>
      <td>216</td>
      <td>36</td>
      <td>2506</td>
      <td>0</td>
      <td>35</td>
      <td>100076</td>
      <td>157</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3903661</th>
      <td>1005</td>
      <td>0</td>
      <td>85f751fd</td>
      <td>c4e18dd6</td>
      <td>50e219e0</td>
      <td>7358e05e</td>
      <td>b9528b13</td>
      <td>cef3e649</td>
      <td>8c2d936a</td>
      <td>4b44384d</td>
      <td>be6db1d7</td>
      <td>1</td>
      <td>0</td>
      <td>456</td>
      <td>320</td>
      <td>50</td>
      <td>122</td>
      <td>3</td>
      <td>1319</td>
      <td>-1</td>
      <td>15</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_dl" class="doc_header"><code>get_dl</code><a href="https://github.com/numb3r33/fgcnn/tree/main/fgcnn/data.py#L72" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_dl</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

